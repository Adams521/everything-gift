# Docker构建网络问题解决方案

## 当前问题

Docker构建卡在 `load metadata for docker.io/library/python:3.12-slim`，这是典型的网络问题。

## 立即解决方案

### 方案1：配置Docker镜像加速器（最快）⚡

```bash
# 1. 创建配置文件（需要sudo权限）
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
EOF

# 2. 重启Docker
sudo systemctl daemon-reload
sudo systemctl restart docker

# 3. 验证配置
docker info | grep -A 5 "Registry Mirrors"

# 4. 停止当前构建（Ctrl+C），然后重新构建
docker compose down
docker compose build --no-cache
docker compose up -d
```

### 方案2：使用一键修复脚本

```bash
sudo ./快速修复网络问题.sh
```

### 方案3：手动拉取镜像（如果方案1不行）

```bash
# 先手动拉取基础镜像
docker pull docker.mirrors.ustc.edu.cn/library/python:3.12-slim
docker tag docker.mirrors.ustc.edu.cn/library/python:3.12-slim python:3.12-slim

# 然后重新构建
docker compose build --no-cache
```

### 方案4：修改Dockerfile使用国内镜像

如果以上方案都不行，可以临时修改Dockerfile：

```bash
# 备份原Dockerfile
cp backend/Dockerfile backend/Dockerfile.original

# 使用国内镜像版本
cp backend/Dockerfile.国内镜像 backend/Dockerfile

# 重新构建
docker compose build --no-cache backend
docker compose up -d
```

## 验证网络连接

```bash
# 测试Docker Hub连接
curl -I https://registry-1.docker.io/v2/

# 测试镜像源连接
curl -I https://docker.mirrors.ustc.edu.cn/v2/
```

## 常用国内镜像源

1. **中科大镜像**: https://docker.mirrors.ustc.edu.cn
2. **网易镜像**: https://hub-mirror.c.163.com
3. **百度云镜像**: https://mirror.baidubce.com
4. **Azure中国**: https://dockerhub.azk8s.cn
5. **阿里云镜像**: 需要登录获取专属地址

## 如果仍然很慢

1. **检查网络**：确保能访问外网
2. **使用代理**：如果有代理，配置Docker使用代理
3. **更换镜像源**：尝试不同的镜像源
4. **使用VPN**：临时使用VPN加速

## 推荐操作步骤

1. **立即执行**（推荐）：
   ```bash
   sudo ./快速修复网络问题.sh
   ```

2. **停止当前构建**：
   - 按 `Ctrl+C` 停止
   - 或新开终端运行：`docker compose down`

3. **清理并重新构建**：
   ```bash
   docker compose down
   docker system prune -f
   docker compose build --no-cache
   docker compose up -d
   ```

## 预期结果

配置成功后，构建速度应该明显提升，通常：
- 下载镜像：从几分钟降到几十秒
- 构建过程：正常进行，不再卡住

## 注意事项

- 配置镜像源需要sudo权限
- 修改配置后必须重启Docker服务
- 如果使用代理，注意配置NO_PROXY排除本地地址
