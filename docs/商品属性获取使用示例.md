# å•†å“å±æ€§è·å–ä½¿ç”¨ç¤ºä¾‹

## ğŸ“ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›å•†å“å±æ€§è·å–åŠŸèƒ½çš„ä½¿ç”¨ç¤ºä¾‹ï¼ŒåŒ…æ‹¬APIè°ƒç”¨å’Œçˆ¬è™«ä½¿ç”¨ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä½¿ç”¨ç»Ÿä¸€æ•°æ®æœåŠ¡è·å–å•†å“ä¿¡æ¯

```python
from app.services.product_data_service import ProductDataService

# åˆ›å»ºæœåŠ¡å®ä¾‹
service = ProductDataService()

# è·å–æ·˜å®å•†å“è¯¦æƒ…ï¼ˆä½¿ç”¨APIï¼‰
product_data = await service.get_product_details(
    platform="taobao",
    product_id="123456789",
    include_reviews=False  # ä¸éœ€è¦è¯¦ç»†è¯„ä»·æ—¶ä½¿ç”¨False
)

# è·å–å•†å“è¯¦æƒ…å¹¶åŒ…å«è¯„ä»·æ•°æ®ï¼ˆä½¿ç”¨API+çˆ¬è™«ï¼‰
product_data_with_reviews = await service.get_product_details(
    platform="taobao",
    product_id="123456789",
    include_reviews=True  # éœ€è¦è¯„ä»·æ•°æ®æ—¶ä½¿ç”¨True
)

# ä¿å­˜å•†å“æ•°æ®åˆ°æ•°æ®åº“
product = await service.save_product_data(product_data)
print(f"å•†å“ID: {product.id}, é”€é‡: {product.sales_count}")
```

### 2. ç›´æ¥ä½¿ç”¨å¹³å°API

#### æ·˜å®è”ç›ŸAPI

```python
from app.services.taobao_union import TaobaoUnionAPI

# åˆ›å»ºAPIå®¢æˆ·ç«¯
api = TaobaoUnionAPI()

# æœç´¢å•†å“
products = await api.search_products(
    keyword="ç”Ÿæ—¥ç¤¼ç‰©",
    page_no=1,
    page_size=20,
    sort="total_sales_des"  # æŒ‰é”€é‡é™åº
)

# è·å–å•†å“è¯¦æƒ…
detail = await api.get_product_detail("123456789")

# è¿”å›çš„æ•°æ®åŒ…å«ï¼š
# - name: å•†å“åç§°
# - price: å½“å‰å”®ä»·
# - original_price: åŸä»·
# - discount_price: æŠ˜æ‰£ä»·
# - image_url: ä¸»å›¾URL
# - image_urls: å›¾ç‰‡åˆ—è¡¨
# - sales_count: é”€é‡
# - sales_amount: é”€å”®é¢ä¼°ç®—
# - shop_name: åº—é“ºåç§°
# - platform_product_id: å¹³å°å•†å“ID
```

#### äº¬ä¸œè”ç›ŸAPI

```python
from app.services.jd_union import JDUnionAPI

# åˆ›å»ºAPIå®¢æˆ·ç«¯
api = JDUnionAPI()

# æœç´¢å•†å“
products = await api.search_products(
    keyword="ç”Ÿæ—¥ç¤¼ç‰©",
    page_index=1,
    page_size=20
)

# è¿”å›çš„æ•°æ®åŒ…å«ï¼š
# - name: å•†å“åç§°
# - price: å½“å‰å”®ä»·
# - original_price: åŸä»·
# - image_urls: å›¾ç‰‡åˆ—è¡¨
# - review_count: è¯„è®ºæ•°
# - good_review_count: å¥½è¯„æ•°
# - good_review_rate: å¥½è¯„ç‡
# - sales_count: 30å¤©é”€é‡
```

### 3. ä½¿ç”¨è¯„ä»·çˆ¬è™«

```python
from app.services.review_crawler import TaobaoReviewCrawler, ReviewCrawlerFactory

# æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨çˆ¬è™«ç±»
async with TaobaoReviewCrawler() as crawler:
    review_data = await crawler.crawl_reviews(
        product_id="123456789",
        platform_url="https://item.taobao.com/item.htm?id=123456789",
        max_reviews=100
    )
    print(f"è¯„ä»·æ€»æ•°: {review_data['review_count']}")
    print(f"å¥½è¯„ç‡: {review_data['good_review_rate']}")

# æ–¹å¼2ï¼šä½¿ç”¨å·¥å‚åˆ›å»º
crawler = ReviewCrawlerFactory.create_crawler("taobao")
if crawler:
    async with crawler:
        review_data = await crawler.crawl_reviews("123456789")
        print(f"è¯„ä»·æ•°æ®: {review_data}")
```

---

## ğŸ“Š æ•°æ®å­—æ®µè¯´æ˜

### Productæ¨¡å‹å®Œæ•´å­—æ®µ

```python
{
    # åŸºç¡€ä¿¡æ¯
    "id": 1,
    "name": "å•†å“åç§°",
    "price": 99.0,  # å½“å‰å”®ä»·
    "original_price": 199.0,  # åŸä»·
    "discount_price": 99.0,  # æŠ˜æ‰£ä»·
    
    # åª’ä½“
    "image_url": "https://...",  # ä¸»å›¾URLï¼ˆå…¼å®¹æ—§å­—æ®µï¼‰
    "image_urls": ["https://...", "https://..."],  # å›¾ç‰‡åˆ—è¡¨
    "video_url": "https://...",  # è§†é¢‘URL
    
    # å¹³å°ä¿¡æ¯
    "platform": "taobao",  # taobao/jd/pdd/xiaohongshu/douyin
    "platform_url": "https://item.taobao.com/item.htm?id=...",
    "platform_product_id": "123456789",  # å¹³å°å•†å“ID
    
    # é”€é‡
    "sales_count": 1000,  # é”€é‡ï¼ˆä»¶æ•°ï¼‰
    "sales_amount": 99000.0,  # é”€å”®é¢ä¼°ç®—ï¼ˆå…ƒï¼‰
    
    # è¯„ä»·
    "review_count": 500,  # è¯„ä»·æ€»æ•°
    "good_review_count": 450,  # å¥½è¯„æ•°
    "bad_review_count": 50,  # å·®è¯„æ•°
    "good_review_rate": 0.9,  # å¥½è¯„ç‡ï¼ˆ0-1ï¼‰
    "average_rating": 4.5,  # å¹³å‡è¯„åˆ†ï¼ˆ1-5æ˜Ÿï¼‰
    
    # åº—é“º
    "shop_name": "åº—é“ºåç§°",
    "shop_url": "https://shop.taobao.com/...",
    
    # å•†å“è§„æ ¼
    "specifications": {
        "å“ç‰Œ": "xxx",
        "é¢œè‰²": "çº¢è‰²",
        "å°ºå¯¸": "L"
    },
    
    # å…ƒæ•°æ®
    "data_source": "api",  # api/crawler
    "last_updated": "2024-01-01T12:00:00",
    "category_id": 1,
    "description": "å•†å“æè¿°"
}
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

### åœºæ™¯ï¼šè·å–å•†å“å®Œæ•´ä¿¡æ¯å¹¶ä¿å­˜

```python
import asyncio
from app.services.product_data_service import ProductDataService
from app.services.review_crawler import ReviewCrawlerFactory

async def get_complete_product_info(platform: str, product_id: str):
    """è·å–å•†å“å®Œæ•´ä¿¡æ¯"""
    service = ProductDataService()
    
    # 1. é€šè¿‡APIè·å–åŸºç¡€å•†å“ä¿¡æ¯
    product_data = await service.get_product_details(
        platform=platform,
        product_id=product_id,
        include_reviews=False
    )
    
    if not product_data:
        print("æ— æ³•è·å–å•†å“åŸºç¡€ä¿¡æ¯")
        return None
    
    # 2. å¦‚æœéœ€è¦è¯„ä»·æ•°æ®ï¼Œä½¿ç”¨çˆ¬è™«è¡¥å……
    if platform in ["taobao", "jd"]:
        crawler = ReviewCrawlerFactory.create_crawler(platform)
        if crawler:
            async with crawler:
                review_data = await crawler.crawl_reviews(
                    product_id=product_id,
                    platform_url=product_data.get("platform_url")
                )
                # åˆå¹¶è¯„ä»·æ•°æ®
                product_data.update(review_data)
    
    # 3. ä¿å­˜åˆ°æ•°æ®åº“
    product = await service.save_product_data(product_data)
    
    print(f"âœ… å•†å“ä¿å­˜æˆåŠŸ: {product.name}")
    print(f"   é”€é‡: {product.sales_count}")
    print(f"   è¯„ä»·æ•°: {product.review_count}")
    print(f"   å¥½è¯„ç‡: {product.good_review_rate}")
    
    return product

# ä½¿ç”¨ç¤ºä¾‹
asyncio.run(get_complete_product_info("taobao", "123456789"))
```

---

## ğŸ› ï¸ APIç«¯ç‚¹ä½¿ç”¨

### è·å–å•†å“è¯¦æƒ…ï¼ˆæ‰©å±•ç‰ˆï¼‰

```python
# åœ¨APIè·¯ç”±ä¸­ä½¿ç”¨
from app.services.product_data_service import ProductDataService

@router.get("/products/{product_id}/details")
async def get_product_details(
    product_id: int,
    include_reviews: bool = False,
    db: Session = Depends(get_db)
):
    """è·å–å•†å“è¯¦ç»†ä¿¡æ¯"""
    product = db.query(Product).filter(Product.id == product_id).first()
    if not product:
        raise HTTPException(status_code=404, detail="å•†å“ä¸å­˜åœ¨")
    
    service = ProductDataService()
    
    # å¦‚æœéœ€è¦æ›´æ–°æ•°æ®æˆ–è·å–è¯„ä»·
    if include_reviews or not product.last_updated:
        product_data = await service.get_product_details(
            platform=product.platform,
            product_id=product.platform_product_id,
            include_reviews=include_reviews
        )
        if product_data:
            # æ›´æ–°å•†å“æ•°æ®
            await service.save_product_data(product_data)
            # é‡æ–°æŸ¥è¯¢
            product = db.query(Product).filter(Product.id == product_id).first()
    
    return ProductResponse.model_validate(product)
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. APIé™åˆ¶

- **æ·˜å®è”ç›ŸAPI**: æœ‰è°ƒç”¨é¢‘ç‡é™åˆ¶ï¼Œå»ºè®®æ§åˆ¶è¯·æ±‚é¢‘ç‡
- **äº¬ä¸œè”ç›ŸAPI**: éœ€è¦å…ˆè·å–access_tokenï¼Œæœ‰è°ƒç”¨é™åˆ¶

### 2. çˆ¬è™«ä½¿ç”¨

- **åçˆ¬è™«æœºåˆ¶**: å„å¹³å°éƒ½æœ‰åçˆ¬è™«æœºåˆ¶ï¼Œéœ€è¦ï¼š
  - ä½¿ç”¨ä»£ç†IP
  - è®¾ç½®åˆç†çš„è¯·æ±‚é—´éš”
  - æ¨¡æ‹ŸçœŸå®ç”¨æˆ·è¡Œä¸º
  - å¤„ç†éªŒè¯ç ï¼ˆå¯èƒ½éœ€è¦äººå·¥ä»‹å…¥ï¼‰

- **æ³•å¾‹åˆè§„**: 
  - éµå®ˆrobots.txt
  - éµå®ˆæœåŠ¡æ¡æ¬¾
  - ä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶

### 3. æ•°æ®å‡†ç¡®æ€§

- **APIæ•°æ®**: ç›¸å¯¹å‡†ç¡®ï¼Œä½†å¯èƒ½ä¸åŒ…å«æ‰€æœ‰å­—æ®µ
- **çˆ¬è™«æ•°æ®**: éœ€è¦éªŒè¯å’Œæ¸…æ´—ï¼Œå¯èƒ½ä¸ç¨³å®š

### 4. æ€§èƒ½ä¼˜åŒ–

- **ç¼“å­˜**: å¯¹é¢‘ç¹æŸ¥è¯¢çš„å•†å“æ•°æ®è¿›è¡Œç¼“å­˜
- **å¼‚æ­¥**: ä½¿ç”¨å¼‚æ­¥è¯·æ±‚æé«˜æ€§èƒ½
- **æ‰¹é‡å¤„ç†**: æ‰¹é‡è·å–å•†å“æ•°æ®æ—¶ä½¿ç”¨å¹¶å‘

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å•†å“å±æ€§è·å–å®ç°æ–¹æ¡ˆ](./å•†å“å±æ€§è·å–å®ç°æ–¹æ¡ˆ.md)
- [æ¥å…¥æ·˜å®è”ç›Ÿå’Œäº¬ä¸œè”ç›Ÿ](./æ¥å…¥æ·˜å®è”ç›Ÿå’Œäº¬ä¸œè”ç›Ÿ.md)
- [APIæ–‡æ¡£](../backend/app/api/)

---

## ğŸ”— å¿«é€Ÿé“¾æ¥

- æ·˜å®å¼€æ”¾å¹³å°: https://open.taobao.com/
- äº¬ä¸œå¼€æ”¾å¹³å°: https://open.jd.com/
- Playwrightæ–‡æ¡£: https://playwright.dev/python/
