# 商品属性获取实现方案

## 📋 需求概述

需要获取以下商品详细属性用于AI分析：
- ✅ 商品图片/视频
- ✅ 销售额/销量
- ✅ 售价（原价、现价、优惠价）
- ✅ 评价总数
- ✅ 好评/差评情况（好评率、差评率、评价分布）
- ✅ 商品详情描述
- ✅ 店铺信息
- ✅ 商品规格参数

**目标平台**: 淘宝、京东、拼多多、小红书、抖音

---

## 🔍 各平台API/爬虫方案分析

### 1. 淘宝/天猫

#### ✅ 推荐方案：淘宝联盟API（官方API）

**优势**:
- ✅ 官方API，稳定可靠
- ✅ 数据完整（包含销量、价格、评价等）
- ✅ 无需处理反爬虫
- ✅ 有佣金收益

**可获取的数据**:
- ✅ 商品标题、价格、图片
- ✅ 销量（volume）
- ✅ 店铺信息
- ✅ 优惠券信息
- ⚠️ **评价数据有限**（联盟API不提供详细评价）

**API文档**: https://open.taobao.com/api.htm

**主要API**:
1. `taobao.tbk.dg.material.optional` - 商品搜索（包含销量）
2. `taobao.tbk.item.info.get` - 商品详情
3. `taobao.tbk.item.coupon.get` - 优惠券信息

**限制**:
- ⚠️ 需要申请API权限（媒体备案 + API申请）
- ⚠️ 有调用频率限制
- ⚠️ 评价数据不完整（需要爬虫补充）

#### ⚠️ 备选方案：爬虫

**适用场景**: 需要详细评价数据时

**技术方案**:
- Playwright/Selenium 模拟浏览器
- 解析商品详情页和评价页

**难点**:
- ⚠️ 反爬虫机制（验证码、登录验证）
- ⚠️ 需要处理动态加载
- ⚠️ 可能被封IP

---

### 2. 京东

#### ✅ 推荐方案：京东联盟API（官方API）

**优势**:
- ✅ 官方API，稳定可靠
- ✅ 数据相对完整
- ✅ 有佣金收益

**可获取的数据**:
- ✅ 商品信息、价格、图片
- ✅ 评论数（comments）
- ✅ 店铺信息
- ⚠️ **销量数据有限**（部分商品有）
- ⚠️ **评价详情不完整**

**API文档**: https://union.jd.com/openplatform/api

**主要API**:
1. `jd.union.open.goods.query` - 商品搜索
2. `jd.union.open.goods.promotiongoodsinfo.query` - 商品详情
3. `jd.union.open.comment.query` - 商品评价（需要特殊权限）

**限制**:
- ⚠️ 需要申请API权限
- ⚠️ 评价API需要额外权限
- ⚠️ 有调用频率限制

#### ⚠️ 备选方案：爬虫

**适用场景**: 需要详细评价和销量数据时

**技术方案**:
- Playwright 模拟浏览器
- 解析商品详情页和评价页

---

### 3. 拼多多

#### ⚠️ 方案：爬虫（无官方API）

**现状**:
- ❌ 无公开的官方API
- ⚠️ 只能使用爬虫

**技术方案**:
- Playwright/Selenium 模拟浏览器
- 解析商品详情页

**难点**:
- ⚠️ 反爬虫机制较强
- ⚠️ 需要登录才能查看详细数据
- ⚠️ 动态加载复杂

**可获取数据**:
- ✅ 商品信息、价格、图片
- ✅ 销量（需登录）
- ✅ 评价（需登录，有限制）

---

### 4. 小红书

#### ⚠️ 方案：爬虫（无官方API）

**现状**:
- ❌ 无公开的官方API
- ⚠️ 只能使用爬虫

**技术方案**:
- Playwright 模拟浏览器
- 解析笔记详情页

**难点**:
- ⚠️ 反爬虫机制强
- ⚠️ 需要登录
- ⚠️ 数据格式不统一（笔记形式）

**可获取数据**:
- ✅ 笔记内容、图片/视频
- ✅ 点赞、收藏、评论数
- ⚠️ 商品信息不完整（主要是种草笔记）

---

### 5. 抖音

#### ⚠️ 方案：抖音开放平台API + 爬虫

**官方API**:
- ✅ 抖音开放平台提供部分API
- ⚠️ 主要用于内容发布，商品数据有限

**爬虫方案**:
- Playwright 模拟浏览器
- 解析商品橱窗/直播间

**难点**:
- ⚠️ 反爬虫机制强
- ⚠️ 需要登录
- ⚠️ 数据动态加载

**可获取数据**:
- ✅ 商品信息、价格、图片/视频
- ✅ 销量（部分）
- ⚠️ 评价数据有限

---

## 🎯 推荐实现方案

### 方案一：混合方案（推荐）⭐

**策略**: 官方API为主 + 爬虫补充

#### 实施步骤

1. **优先使用官方API**（淘宝联盟、京东联盟）
   - 获取基础商品信息（标题、价格、图片、销量）
   - 稳定可靠，有收益

2. **爬虫补充评价数据**
   - 对于需要详细评价的商品，使用爬虫获取
   - 仅爬取评价页，不爬取商品详情（减少风险）

3. **数据存储和更新**
   - 定期更新商品基础信息（通过API）
   - 按需更新评价数据（通过爬虫）

#### 优势
- ✅ 稳定性和效率平衡
- ✅ 降低被封风险
- ✅ 数据相对完整
- ✅ 有佣金收益

---

### 方案二：纯API方案

**适用场景**: 不需要详细评价数据，或评价数据可通过其他方式获取

**实施**:
- 仅使用淘宝联盟、京东联盟API
- 评价数据通过用户反馈或其他渠道补充

**优势**:
- ✅ 最稳定
- ✅ 无需处理反爬虫
- ✅ 有佣金收益

**劣势**:
- ❌ 评价数据不完整
- ❌ 拼多多、小红书、抖音无法覆盖

---

### 方案三：纯爬虫方案

**适用场景**: 需要完整数据，且愿意承担风险

**实施**:
- 所有平台使用爬虫
- 需要处理反爬虫、代理IP、验证码等

**优势**:
- ✅ 数据最完整
- ✅ 可覆盖所有平台

**劣势**:
- ❌ 不稳定（可能被封）
- ❌ 维护成本高
- ❌ 法律风险

---

## 🏗️ 技术架构设计

### 数据模型扩展

需要扩展 `Product` 模型以支持更多属性：

```python
class Product(Base):
    # 基础信息（已有）
    id, name, price, image_url, platform, platform_url, category_id, description
    
    # 新增字段
    original_price = Column(Float)  # 原价
    discount_price = Column(Float)  # 折扣价
    sales_count = Column(Integer)  # 销量
    sales_amount = Column(Float)  # 销售额（估算）
    
    # 评价相关
    review_count = Column(Integer)  # 评价总数
    good_review_count = Column(Integer)  # 好评数
    bad_review_count = Column(Integer)  # 差评数
    good_review_rate = Column(Float)  # 好评率（0-1）
    average_rating = Column(Float)  # 平均评分（1-5）
    
    # 媒体
    image_urls = Column(JSON)  # 商品图片列表
    video_url = Column(String)  # 商品视频URL
    
    # 店铺信息
    shop_name = Column(String)  # 店铺名称
    shop_url = Column(String)  # 店铺链接
    
    # 商品参数
    specifications = Column(JSON)  # 商品规格参数（JSON格式）
    
    # 数据来源
    data_source = Column(String)  # api/crawler 数据来源
    last_updated = Column(DateTime)  # 最后更新时间
```

### 服务层设计

```
app/services/
├── product_data_service.py    # 统一商品数据服务（入口）
├── taobao_union.py           # 淘宝联盟API（已有）
├── jd_union.py               # 京东联盟API（已有）
├── pdd_crawler.py            # 拼多多爬虫
├── xiaohongshu_crawler.py    # 小红书爬虫
├── douyin_crawler.py         # 抖音爬虫
└── review_crawler.py         # 评价爬虫（通用）
```

### 数据获取流程

```
用户请求商品数据
    ↓
ProductDataService（统一入口）
    ↓
判断平台和数据需求
    ↓
┌─────────────────┬─────────────────┐
│  官方API路径      │   爬虫路径       │
│  (优先)          │   (补充)        │
└─────────────────┴─────────────────┘
    ↓                    ↓
基础商品信息         详细评价数据
    ↓                    ↓
    合并数据
    ↓
    存储到数据库
    ↓
    返回给用户
```

---

## 📝 实施计划

### 第一阶段：扩展数据模型（1-2天）

1. 创建数据库迁移脚本，扩展Product表
2. 更新Pydantic schemas
3. 更新现有API返回字段

### 第二阶段：完善官方API集成（2-3天）

1. 完善淘宝联盟API（获取更多字段）
2. 完善京东联盟API（获取更多字段）
3. 统一API返回格式

### 第三阶段：实现爬虫模块（1-2周）

1. 实现评价爬虫（通用，支持多平台）
2. 实现拼多多爬虫
3. 实现小红书爬虫
4. 实现抖音爬虫

### 第四阶段：统一数据服务（3-5天）

1. 实现ProductDataService统一入口
2. 实现数据合并逻辑
3. 实现缓存机制
4. 实现定时更新任务

### 第五阶段：测试和优化（3-5天）

1. 测试各平台数据获取
2. 优化爬虫稳定性
3. 处理异常情况
4. 性能优化

---

## ⚠️ 注意事项

### 法律合规

1. **遵守robots.txt**
   - 检查各平台的robots.txt
   - 遵守爬取规则

2. **遵守服务条款**
   - 阅读并遵守各平台的服务条款
   - 不得用于商业竞争等违规用途

3. **数据使用**
   - 仅用于学习和研究
   - 不得大规模商业化使用爬虫数据

### 技术风险

1. **反爬虫机制**
   - 使用代理IP池
   - 设置合理的请求频率
   - 模拟真实用户行为

2. **数据准确性**
   - API数据相对准确
   - 爬虫数据需要验证和清洗

3. **稳定性**
   - API相对稳定
   - 爬虫需要监控和自动重试机制

### 成本考虑

1. **API成本**
   - 淘宝联盟、京东联盟：免费（有佣金收益）
   - 需要申请和审核

2. **爬虫成本**
   - 服务器成本（代理IP、验证码识别等）
   - 维护成本

---

## 📊 各平台数据获取能力对比

| 平台 | 官方API | 爬虫难度 | 数据完整性 | 推荐方案 |
|------|---------|----------|------------|----------|
| 淘宝 | ✅ 有 | 中等 | 高（API+爬虫） | API为主+爬虫补充评价 |
| 京东 | ✅ 有 | 中等 | 中高 | API为主+爬虫补充评价 |
| 拼多多 | ❌ 无 | 高 | 中 | 爬虫 |
| 小红书 | ❌ 无 | 高 | 中 | 爬虫（主要是笔记数据） |
| 抖音 | ⚠️ 部分 | 高 | 中 | API+爬虫混合 |

---

## 🚀 快速开始

### 1. 申请API权限

**淘宝联盟**:
1. 访问 https://www.alimama.com/
2. 媒体备案 → 申请API权限
3. 获取 App Key、App Secret、PID

**京东联盟**:
1. 访问 https://union.jd.com/
2. 网站备案 → 申请API权限
3. 获取 App Key、App Secret、Site ID

### 2. 配置环境变量

```bash
# 淘宝联盟
TAOBAO_UNION_APP_KEY=your_key
TAOBAO_UNION_APP_SECRET=your_secret
TAOBAO_UNION_PID=mm_xxx_xxx_xxx

# 京东联盟
JD_UNION_APP_KEY=your_key
JD_UNION_APP_SECRET=your_secret
JD_UNION_SITE_ID=your_site_id
```

### 3. 运行数据获取

```python
from app.services.product_data_service import ProductDataService

service = ProductDataService()
product_data = await service.get_product_details(
    platform="taobao",
    product_id="123456",
    include_reviews=True  # 需要评价数据时使用爬虫
)
```

---

## 📚 参考资源

- 淘宝开放平台: https://open.taobao.com/
- 京东开放平台: https://open.jd.com/
- Playwright文档: https://playwright.dev/python/
- 反爬虫对抗指南: 需要根据实际情况调整策略

---

**推荐方案**: 混合方案（官方API + 爬虫补充），优先使用淘宝联盟和京东联盟API获取基础数据，使用爬虫补充评价等详细数据。
